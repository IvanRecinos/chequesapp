<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Cheques</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold">Historial de Cheques</h1>
    <button id="btn-regresar" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Regresar</button>
  </div>

  <div class="flex items-center gap-4 mb-4">
    <select id="filtroTipo" class="p-2 border rounded">
      <option value="">Seleccionar filtro</option>
      <option value="banco">Buscar por Banco</option>
      <option value="cliente">Buscar por Cliente</option>
      <option value="fecha">Buscar por Rango de Fechas</option>
    </select>

    <div id="campoFiltro" class="flex gap-2 items-center"></div>

    <button id="btnBuscar" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Buscar</button>
  </div>

  <br />

  <table class="w-full border-collapse bg-white shadow-md">
    <thead class="bg-gray-200">
      <tr>
        <th class="p-2 border"><input type="checkbox" id="selectAll" /></th>
        <th class="p-2 border">N° Cheque</th>
        <th class="p-2 border">Cliente</th>
        <th class="p-2 border">Banco</th>
        <th class="p-2 border">Monto</th>
        <th class="p-2 border">Fecha</th>
        <th class="p-2 border">Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaHistorial">
      <!-- Datos del historial se cargan aquí -->
    </tbody>
  </table>

  <!-- Modal de edición -->
  <div id="modalEditar" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
    <div class="bg-white rounded shadow-lg w-full max-w-xl p-4">
      <h2 class="text-xl font-semibold mb-3">Editar cheque</h2>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium">N° Cheque</label>
          <input id="editNoCheque" type="text" class="w-full p-2 border rounded"/>
        </div>
        <div>
          <label class="block text-sm font-medium">Beneficiario</label>
          <input id="editBeneficiario" type="text" class="w-full p-2 border rounded"/>
        </div>
        <div>
          <label class="block text-sm font-medium">Banco</label>
          <select id="editBanco" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">Monto</label>
          <input id="editMonto" type="text" inputmode="decimal" class="w-full p-2 border rounded" placeholder="1,234.56"/>
        </div>
        <div class="col-span-2">
          <label class="block text-sm font-medium">Monto en letras</label>
          <input id="editMontoLetras" type="text" class="w-full p-2 border rounded bg-gray-50" readonly/>
        </div>
        <div>
          <label class="block text-sm font-medium">Lugar</label>
          <input id="editLugar" type="text" class="w-full p-2 border rounded"/>
        </div>
        <div>
          <label class="block text-sm font-medium">Fecha (texto)</label>
          <input id="editFecha" type="text" class="w-full p-2 border rounded" placeholder="ej. 23 de octubre de 2025"/>
        </div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="btnCancelarEdit" class="px-3 py-2 rounded border">Cancelar</button>
        <button id="btnGuardarEdit" class="px-3 py-2 rounded bg-blue-600 text-white">Guardar cambios</button>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('btn-regresar').addEventListener('click', () => {
      window.electronAPI.abrirPrincipal();
    });
    const filtroTipo = document.getElementById('filtroTipo');
    const campoFiltro = document.getElementById('campoFiltro');
    const btnBuscar = document.getElementById('btnBuscar');
    const tablaHistorial = document.getElementById('tablaHistorial');
    const selectAll = document.getElementById('selectAll');

  let bancos = [];
    let clientes = [];
  let edicionActualId = null;

    // Obtener bancos y clientes al cargar
    window.electronAPI.obtenerBancos().then(data => {
      bancos = data;
      // poblar select del modal de edición
      const sel = document.getElementById('editBanco');
      sel.innerHTML = '';
      bancos.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b; opt.textContent = b; sel.appendChild(opt);
      });
    });
    window.electronAPI.obtenerBeneficiarios().then(data => clientes = data);

    filtroTipo.addEventListener('change', () => {
      const tipo = filtroTipo.value;
      campoFiltro.innerHTML = '';

      if (tipo === 'banco') {
        const select = document.createElement('select');
        select.id = 'filtroBanco';
        select.className = 'p-2 border rounded';
        bancos.forEach(banco => {            
          const option = document.createElement('option');
          option.value = banco;
          option.textContent = banco;
          select.appendChild(option);
        });
        campoFiltro.appendChild(select);

      } else if (tipo === 'cliente') {
        const select = document.createElement('select');
        select.id = 'filtroCliente';
        select.className = 'p-2 border rounded';
        clientes.forEach(cliente => {
          const option = document.createElement('option');
          option.value = cliente;
          option.textContent = cliente;
          select.appendChild(option);
        });
        campoFiltro.appendChild(select);

      } else if (tipo === 'fecha') {
        const desde = document.createElement('input');
        desde.type = 'date';
        desde.id = 'fechaDesde';
        desde.className = 'p-2 border rounded';
        const hasta = document.createElement('input');
        hasta.type = 'date';
        hasta.id = 'fechaHasta';
        hasta.className = 'p-2 border rounded';
        campoFiltro.appendChild(desde);
        campoFiltro.appendChild(hasta);
      }
    });

    btnBuscar.addEventListener('click', async () => {
      const tipo = filtroTipo.value;
      let resultados = [];

      if (tipo === 'banco') {
        const banco = document.getElementById('filtroBanco').value;
        resultados = await window.electronAPI.buscarPorBanco(banco);

      } else if (tipo === 'cliente') {
        const cliente = document.getElementById('filtroCliente').value;
        resultados = await window.electronAPI.buscarPorCliente(cliente);

      } else if (tipo === 'fecha') {
        const desde = document.getElementById('fechaDesde').value;
        const hasta = document.getElementById('fechaHasta').value;
        resultados = await window.electronAPI.buscarPorRango({ desde, hasta });

      } else {
        alert('Selecciona un filtro primero.');
        return;
      }

      cargarTabla(resultados);
    });

    selectAll.addEventListener('change', () => {
      document.querySelectorAll('.fila-checkbox').forEach(cb => {
        cb.checked = selectAll.checked;
      });
    });

    function cargarTabla(data) {
      tablaHistorial.innerHTML = '';

      data.forEach(row => {
        const tr = document.createElement('tr');

        const checkboxTd = document.createElement('td');
        checkboxTd.className = 'border p-2 text-center';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'fila-checkbox';
        checkboxTd.appendChild(cb);
        tr.appendChild(checkboxTd);

        tr.innerHTML += `
          <td class="border p-2 text-center">${row.noCheque}</td>
          <td class="border p-2 text-center">${row.beneficiario}</td>
          <td class="border p-2 text-center">${row.banco}</td>
          <td class="border p-2 text-center">Q${formatMonto(row.monto)}</td>
          <td class="border p-2 text-center">${row.fecha}</td>
        `;

        const accionesTd = document.createElement('td');
        accionesTd.className = 'border p-2 text-center';
        const btnEditar = document.createElement('button');
        btnEditar.textContent = 'Editar';
        btnEditar.className = 'bg-blue-600 text-white px-2 py-1 rounded mr-2 hover:bg-blue-700';
        btnEditar.onclick = () => abrirModalEditar(row.id);

        const btnEliminar = document.createElement('button');
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.className = 'bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700';
        btnEliminar.onclick = () => eliminarRegistro(row.id);

        accionesTd.appendChild(btnEditar);
        accionesTd.appendChild(btnEliminar);
        tr.appendChild(accionesTd);

        tablaHistorial.appendChild(tr);
      });
    }

    // Formateo/parse de montos (miles)
    function parseMonto(texto) {
      if (typeof texto !== 'string') texto = String(texto ?? '');
      const limpio = texto.replace(/[^0-9,.-]/g, '').trim();
      if (!limpio) return NaN;
      if (/,/.test(limpio) && /\./.test(limpio)) {
        return parseFloat(limpio.replace(/,/g, ''));
      }
      if (/,/.test(limpio) && !/\./.test(limpio)) {
        return parseFloat(limpio.replace(/\./g, '').replace(/,/g, '.'));
      }
      return parseFloat(limpio.replace(/,/g, ''));
    }
    function formatMonto(n) {
      const num = typeof n === 'number' ? n : parseMonto(n);
      if (isNaN(num)) return '0.00';
      return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
    }

    // Modal edición
    const modal = document.getElementById('modalEditar');
    const editNoCheque = document.getElementById('editNoCheque');
    const editBeneficiario = document.getElementById('editBeneficiario');
    const editBanco = document.getElementById('editBanco');
    const editMonto = document.getElementById('editMonto');
    const editMontoLetras = document.getElementById('editMontoLetras');
    const editLugar = document.getElementById('editLugar');
    const editFecha = document.getElementById('editFecha');
    const btnCancelarEdit = document.getElementById('btnCancelarEdit');
    const btnGuardarEdit = document.getElementById('btnGuardarEdit');

    function numeroALetrasLocal(num) {
      try {
        const partes = Number(num).toFixed(2).split('.');
        const cent = partes[1] || '00';
        return `${Math.floor(Number(num))} con ${cent}/100`;
      } catch { return ''; }
    }

    editMonto.addEventListener('input', (e) => {
      const val = parseMonto(e.target.value);
      e.target.value = isNaN(val) ? '' : new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
      editMontoLetras.value = isNaN(val) ? '' : numeroALetrasLocal(val);
    });

    function abrirModalEditar(id) {
      edicionActualId = id;
      window.electronAPI.editarCheque(id).then(row => {
        if (!row) return;
        editNoCheque.value = row.noCheque || '';
        editBeneficiario.value = row.beneficiario || '';
        editBanco.value = row.banco || '';
        editMonto.value = formatMonto(row.monto);
        editMontoLetras.value = numeroALetrasLocal(parseMonto(row.monto));
        editLugar.value = row.lugar || '';
        editFecha.value = row.fecha || '';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      });
    }

    btnCancelarEdit.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      edicionActualId = null;
    });

    btnGuardarEdit.addEventListener('click', async () => {
      if (!edicionActualId) return;
      const montoNum = parseMonto(editMonto.value);
      const datos = {
        noCheque: editNoCheque.value.trim(),
        beneficiario: editBeneficiario.value.trim(),
        banco: editBanco.value,
        monto: montoNum,
        montoLetras: numeroALetrasLocal(montoNum),
        lugar: editLugar.value.trim(),
        fecha: editFecha.value.trim(),
      };
      try {
        await window.electronAPI.actualizarCheque(edicionActualId, datos);
        alert('Cambios guardados');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        btnBuscar.click();
      } catch (e) {
        alert('Error al guardar cambios: ' + e.message);
      }
    });

    function eliminarRegistro(id) {
      if (confirm('¿Estás seguro que deseas eliminar este cheque?')) {
        // Puedes crear un canal IPC para eliminar el cheque desde el main y recargar
        window.electronAPI.eliminarCheque(id).then(() => {
          alert('Cheque eliminado.');
          btnBuscar.click();
        });
      }
    }

    function editarRegistro(row) {}
  </script>
</body>
</html>
